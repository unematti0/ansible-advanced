# {{ ansible_managed }}
# Nginx Configuration for {{ inventory_hostname }}
# Environment: {{ app_env }}

server {
    listen {{ http_port }};
    server_name {{ item.name }};
    
    root {{ item.document_root }};
    index index.html index.php;
    
    # Logging configuration
    {% if debug_mode %}
    access_log /var/log/nginx/{{ item.name }}_access.log;
    error_log /var/log/nginx/{{ item.name }}_error.log debug;
    {% else %}
    access_log /var/log/nginx/{{ item.name }}_access.log;
    error_log /var/log/nginx/{{ item.name }}_error.log warn;
    {% endif %}
    
    location / {
        try_files $uri $uri/ =404;
    }
    
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php{{ php_version }}-fpm.sock;
    }
    
    {% if app_env == 'production' %}
    # Production security headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    {% endif %}
}

{% if item.ssl_enabled and ssl_enabled %}
# SSL Configuration
server {
    listen {{ https_port }} ssl;
    server_name {{ item.name }};
    
    ssl_certificate {{ ssl_cert_path }};
    ssl_certificate_key {{ ssl_key_path }};
    ssl_protocols TLSv1.2 TLSv1.3;
    
    root {{ item.document_root }};
    index index.html index.php;
}
{% endif %}